---
title: "hw_3_3"
author: "Бикмаев Руслан"
date: "10 10 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ДЗ 3.3

 Для упражнения используются  данные so.csv, прекрепленные к материалам прошлого урока
1. Загрузите данные.
2. Произведите необходимые преобразования.
3. Вычислите временной промежуток в днях (число дней) с первого по последний пост пользователя "Шелест", либо любого на ваш выбор.

```{r message=FALSE, results='hide'}
if(!require('pacman')) install.packages('pacman')
pacman::p_load(data.table)
```

### Загрузка данных

```{r message=FALSE}
so <- fread('so.csv', encoding = 'UTF-8')
so_ind <- copy(so)
```

```{r}
setnames(
  so,
  c('user', 'usid', 'postid', 'date', 'quoter', 'text', 'url', 'id', '')
)

so[, c('') := NULL]
str(so)
```

### Черновик

Фомат парсинга даты-времени в этом наборе данных уже обсуждали на вебинаре.

```{r}
so[, created := as.POSIXct(
    date,
    tz = 'Europe/Moscow',
    format = ' %a %b %d, %Y %I:%M %p '
  )
]

str(so)
```

Предпросмотр данных позволяет надеяться, что дата-время спарсилось нормально. Посмотрим сводную статистику:

```{r}
summary(so)
```

155 489 пропущенных значений! Что они из себя представляют?

```{r}
so[is.na(created), .(user, date, quoter, created)]
x <- so[is.na(created), date]
(x <- x[1:80])
```

На другой локали (например, Windows-1252), пропущенных значений может быть больше. Тогда понадобятся дополнительные преобразования.

```{r}
# Иногда вместо "pm" необходимо "пополудни":
strptime(" Пн мар 28, 2016 3:38 пополудни ", format = ' %a %b %d, %Y %I:%M %p ')
# Иногда парсер понимает "pm":
strptime(" Пн мар 28, 2016 3:38 pm ", format = ' %a %b %d, %Y %I:%M %p ')
strptime(" Пн мар 28, 2016 3:38 am ", format = ' %a %b %d, %Y %I:%M %p ')
```

Например, преобразования могут быть такими

```{r eval=FALSE}
so[, created := {date = gsub('pm\\s*$', 'пополудни', date)
  # date = gsub(' am\\s*$', '', date) # это лишнее: as.POSIXct распознает "am"
  date = gsub('^\\s+', '', date)
  date = gsub('\\s{2,}', ' ', date)
  date = gsub('\\s+$', '', date)
  date = as.POSIXct(
    date,
    tz = 'Europe/Moscow',
    format = '%a %b %d, %Y %I:%M %p'
  )
},
]

str(so)
summary(so)
```

Но указанные воскресенья марта всегда остаются неопознанными. Что с ними не так?

Что между ними общего?

* воскресенье;
* конец марта;
* 2 часа ночи.

Последнее воскресенье марта?

Ответ:

Последнее [воскресенье марта](https://grad.ua/lenta-novostey/74993-poslednee-voskresene-marta-stanet-na-chas-koroche.html) — [день перехода на летнее время](https://ru.wikipedia.org/wiki/%D0%9B%D0%B5%D1%82%D0%BD%D0%B5%D0%B5_%D0%B2%D1%80%D0%B5%D0%BC%D1%8F#%D0%A0%D0%B5%D0%B3%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D1%8B%D0%B9_%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4_%D1%87%D0%B0%D1%81%D0%BE%D0%B2).

Решение [нашлось](https://stackoverflow.com/a/44606739) на StackOverflow.

```{r}
so[, created := as.POSIXct(
    date,
    tz = 'UTC',
    format = ' %a %b %d, %Y %I:%M %p '
  )
]

str(so)
summary(so)
```

155 462 Пропущенных значений. Кто они?

```{r}
head(so[is.na(created), .(user, date, quoter, created)], 80)
x <- so[is.na(created), date]
all(x == '')
```

Теперь все пропущенные значения даты-времени — это настоящие пропущенные значения. Пришлось использовать зону UTC, но для данного задания временной пояс не принципиален. Кстати, таблица показывает, что и другие столбцы пусты, но это не для данного задания.

### Решение

```{r}
setkey(so, user)
so[user == 'Шелест', .(user, usid, date, quoter, created)][c(1, .N)]
so[user == 'Шелест', .(ans = difftime(created[.N], created[1]))]
```
Желательно сдать домашнее задание до 23:59 20.10.2019 г.

**Задание считается выполненным, когда:**
 * Домашняя работа сдана (1 балл)
 * Измерения проведены корректно, описание подробное (1 балл)
 * Код оформлен согласно рекомендациям tidyverse (1 балл)
 * Произведено вычисление временного периода (1 балла)
 

**Дополнительные баллы:**
* Вычисление временного периода произведено  правильно (1 балл) 
 
**Минимальное количество баллов для зачета - 4**

