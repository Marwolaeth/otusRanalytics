---
title: "hw_2_3: data.table - основы"
author: "Андрей Павлюченко"
output: html_document
---

В данном домашнем задании Вам будет предложено потренироваться в основах работы с `data.table`: чтении, фильтрации, выбору колонок, агрегированию и вычислениям. В задании будет использоваться набор данных [Bank Marketing Data Set ](https://archive.ics.uci.edu/ml/datasets/Bank+Marketing), содержащий данные маркетинговой кампании в одном из банков Португалии. Набор находится в свободном доступе и доступен как в личном кабинете, так и на сайте UCI. Описание к данным можно найти в файле `bank-names.txt`.

Во всех заданиях нужно использовать синтаксис `data.table`.

При возникновении вопросов напишите преподавателю в чат. Рекомендуемый срок - до 6.10.2019 включительно.

## Подготовка

Подключим пакет `data.table` и загрузим данные при помощи `fread`:

```{r}
if (!require(data.table)) install.packages('data.table')
library(data.table)

if (!file.exists('bank/bank-full.csv')) {
  download.file(
    'https://archive.ics.uci.edu/ml/machine-learning-databases/00222/bank.zip',
    destfile = 'bank.zip'
  )
  unzip('bank.zip', exdir = 'bank')
}

bank_data <- fread(
  'bank/bank-full.csv',
  stringsAsFactors = TRUE # Все строковые переменные в датасете — факторы
)
```

Вывести: количество наблюдений и переменных, класс, а также структуру данных:

```{r}
dim(bank_data)
str(bank_data)
```

Кратко опишите объект данных:

*Данные содержат информацию по телемаркетинговой кампании одного из португальских банков. Набор данных предназначен для тренировки алгоритмов машинного обучения; каждое наблюдение — звонок клиенту; зависимая переменная `y` — результат переговоров с клиентом: оформил ли клиент срочный вклад, среди объясняющих переменных — экономические и демографические характеристики клиента, информация о предшествующих переговорах, а так же (в расширенном наборе) — некоторые экономические показатели на момент звонка.*

## 1 Фильтрация

__*Задания*__: 

1. (0.5 балла) Показать записи соответствующие клиентам возрастом от 25 до 40 лет, являющихся предпренимателями (entrepreneur) или самозанятыми (self-employed), без кредитов.

```{r}
bank_data[(age %in% 25:40) &
          (job %in% c('entrepreneur', 'self-employed')) &
          # оказалось, %chin% не работает с факторами
          (loan == 'no') & (housing == 'no')]
```

2. (0.5 балла) Вывести записи по клиентам, у которых неизвестно образование или занятость.

```{r}
bank_data[job == 'unknown' | education == 'unknown']
```

## 2 Выбор колонок и вычисления

__*Задания*__: 

1. (0.5 балла) Найти количество студентов.

```{r}
bank_data[job == 'student', .N]
```

2. (0.5 балла) Определить средний возраст клиентов с дефолтом (банкротов). 

```{r}
bank_data[default == 'yes', mean(age)]
```

3. (0.5 балла) Найти возраст, занятость, образование, баланс и дату последнего обращения (день и месяц) для клиента в возрасте от 60ти лет (включительно) с максимальным балансом.

```{r}
bank_data[age >= 60,
          .SD[which.max(balance)],
          .SDcols = c('age', 'job', 'education', 'balance', 'day', 'month')]
```

4. (0.5 балла) Используя предоставленное зерно, сделать выборку из 250 респондентов (без замен) и получить по ним вектор длительности контакта. Построить по этому вектору гистограмму (функция `hist()`). Для генерации индексов для выборки используйте функцию `sample()`. На какое распределение похожа полученная гистограмма?

```{r}
set.seed(5555)
dur_sample <- bank_data[sample(1:.N, 250), duration]
# Раскоментить перед выполнением
hist(dur_sample,
              xlab = "Duration of contact",
              main = "Histogram of contact duration",
              breaks = 20)
```

*Гистограмма похожа на унимодальное распределение дискретной величины с положительной асимметрией, например, логарифмическое.*

## 3 Агрегации

__*Задания*__: 

1. (0.5 балла) Найти средний баланс, возраст и количество для каждого типа занятости. Предоставить собственные имена колонок (кроме количества). Отсортировать по убыванию баланса.

```{r}
bank_data[,
          .(.N,
          mean_balance = mean(balance),
          mean_age = mean(age)),
          by = job][order(-mean_balance)]
```

2. (0.5 балла) Внутри каждой группы по типу занятости, найти клиентов с минимальным балансом.

```{r}
bank_data[, .SD[which.min(balance)], by = job]
```

3*. (1 балл) Внутри каждой группы по типу занятости, найти количество клиентов с балансом выше среднего по этой группе. Вывести количество клиентов и средний баланс.

```{r}
bank_data[, .SD[balance > mean(balance),
                .(.N, mean_balance = mean(balance))],
          by = job]
```

___

Критерии оценивания:

 * Домашняя работа сдана (1 балл)
 * Решена 1 задача, описание подробное (1 балл)
 * Решена 2 задача (2 балла)
 * Решена 3 задача (2 балла)
 * Код оформлен согласно рекомендациям tidyverse (1 балл)
 * В каждой задаче использовались только возможности `data.table` (1 балл)
 * Задание сдано до рекомендуемого дедлайна (1 балл)
 * Задание сдано с 1 попытки (1 балл)
 
Задание считается выполненным, если набирается 6 баллов