---
title: "hw_4_3"
author: "Бикмаев Руслан"
date: "03 11 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## ДЗ 4.3

 Для упражнения используются  данные so.csv, прекрепленные к материалам прошлого урока
1. Загрузите данные.
2. Сделайте выборку из 5 произвольных пользователей, сформировавших достаточное количество данных (постов).
3. Нарежьте и сгруппируйте данные по времени суток, используя отрезки от 1 до 3-х часов. То есть разбив сутки на отрезки через 1, 2 или 3 часа на выбор. Можно из колонки с датами взять только часы - это разобьет сутки по часу.
4. Создайте колонку, отражающую степень разговорчивости пользователя, измеряющую число слов в каждом посте. Число постов в конкретный период времени измерять не нужно.
5. Самостоятельно выбирите систему визуализации данных, наиболее наглядно, на ваш взгляд, отражающую степень разговорчивости пользователя (из данной выборки), в зависимости от времени суток и постройте графики.
В связи с различием настройки локалей в разных системах, выполните задание в формате pdf  или html.


Желательно сдать домашнее задание до 23:59 10.11.2019 г.

**Задание считается выполненным, когда:**
 * Домашняя работа сдана (1 балл)
 * Измерения проведены корректно, описание подробное (1 балл)
 * Код оформлен согласно рекомендациям tidyverse (1 балл)
 * Графики отражают оговоренную в задаче взаимосвязь (2 балла)
 

**Минимальное количество баллов для зачета - 5**

### 1. Парсинг даты-времени и очистка данных

```{r message=FALSE, results='hide'}
if(!require('pacman')) install.packages('pacman')
pacman::p_load(data.table, lubridate, ggplot2, stringr, colorspace)
```

```{r message=FALSE}
if (!exists('so')) {
  so <- fread('so.csv', encoding = 'UTF-8')
  so_ind <- copy(so) 
}
```

Присваиваем переменным осмысленные имена и избавляемся от лишней (пустой) колонки.

```{r}
str(so)
setnames(
  so,
  c('user', 'usid', 'postid', 'date', 'quoter', 'text', 'url', 'id', 'smth')
)

so[, c('smth') := NULL]
str(so)
```

Парсинг даты-времени создания поста в машиночитаемый формат — из задания 3.4:

```{r}
so[, created := as.POSIXct(
    date,
    tz = 'UTC',
    format = ' %a %b %d, %Y %I:%M %p '
  )
]

str(so)
summary(so)
```

Пропущенных значений больше 150 тысяч... В остальном переменная `created` смотрится убедительно. Видно, что в базе представлены сообщения с марта 2007 по октябрь 2018.

```{r}
head(so[is.na(created), .(user, date, quoter, created)], 80)
# Все значения пустые?
# Везде ли, где обработанное время поста NA исходное значение даты — пустое?
x <- so[is.na(created), date]
all(x == '')
rm(x)
```

Итого, все 150+ тыс. пропущенных значений — действительно пропущенные значения, а не ошибка парсинга. Что с остальными исходными значениями?

```{r}
summary(so[is.na(created), lapply(.SD, as.factor)]) # Красота
```

Теперь можно избавиться от всех строк с пропущенными значениями времени создания поста

```{r}
so <- so[!is.na(created)]
so_cl <- copy(so)
```

### Анализ

1. Первая задача —создать переменную — час суток публикации поста

```{r}
so[, hour := {
  # Округлим даты при помощи lubridate
  h = floor_date(created, unit = '2 hours')
  # Другой вариант: as.numeric(format(created, '%H'))
  h = hour(h)
  }
]
str(so)
summary(so$hour)
```

2. Вторая — найти топ самых активных пользователей

```{r}
setkey(so, user)
so <- so[user %chin% so[, .N, by = user][order(-N)][1:5, user]]
summary(so)

so[, .(last_post = max(created)), by = user]
```

ТОП-5 пользователей по количеству постов вместе сгенерировали более 78 тыс. сообщений. И все они были активны в период сбора информации с форума — октябрь 2018.

3. Рассчитать количество слов в постах

```{r}
so[, nwords := stringr::str_count(text, "\\w+")]

# Небольшая сводная статистика
so[, .(
  sum    = sum(nwords),
  mean   = mean(nwords),
  median = median(nwords),
  nposts = .N
),
by = user
]
```

4. Оценить «словесную активность» выбранных пользователей по времени суток

Вопрос: какой показатель сводки количества слов выбрать в качестве меры активности?

* Меры центральной тенденции отпадают: при *большом* количестве **коротких** постов эти показатели будут слишком низкими.
* Сумма слов — более корректно отразит динамику активности каждого пользователя, но из-за большого разброса общего количества слов по пользователям (от 300 тыс. до 1,05 млн) затруднит сравнение паттернов активности пользователей между собой.
* Доля количества слов, приходящаяся на каждый двухчасовой период — позволит как проследить изменение активности пользователей, так и сравнить их между собой.

Попробуем рассчитать второй и третий показатели и использовать их на диаграммах.

```{r}
setkey(so, user, hour)
so_sum <- so[,
  .(n_words  = sum(nwords),
    m_words  = mean(nwords),
    md_words = as.numeric(median(nwords)),
    q1_words = quantile(nwords, .25),
    q3_words = quantile(nwords, .75)),
  by = .(user, hour)
]

so_total <- so_sum[,
  .(total_words = sum(n_words)),
  by = user
]

# Мне очень не нравится этот подход с созданием дополнительной таблицы
# Буду благодарен за подсказку, как сделать это экономнее

so_sum <- so_total[so_sum]
rm(so_total)
so_sum[, p_words := n_words / total_words]
summary(so_sum)
```

```{r}
ggplot(
  so_sum,
  aes(
    x = hour,
    y = p_words,
    colour = factor(user)
  )) +
  geom_line(lwd = 2, show.legend = FALSE) +
  scale_x_continuous(
    'Время суток',
    breaks = seq(0, 22, 2),
    minor_breaks = NULL,
    limits = c(0, 22),
    expand = c(.01, .01),
    labels = function(x) sprintf('%d–%d', x, x + 2)
  ) +
  scale_y_continuous(
    '% от всех слов',
    labels = function(x) scales::percent(x, accuracy = 1)
  ) +
  scale_colour_discrete_qualitative(
    name = 'Пользователь',
    palette = 'Dynamic'
  ) +
  facet_wrap(~ user, ncol = 1) +
  theme_light() +
  ggtitle('ТОП-5 пользователей: активность по времени суток')
```

Паттерны активности топ-пользователей Социофорума примерно совпадают (за исключением пользователя ```Darlana```): низкая активность в ночное время, пик активности приходится на вторую половину дня (у пользователtей ```Штушкутуш``` и ```Багирко``` — примерно послеобеденное время, у пользователей ```Gabriela``` и ```sute_girl``` — ближе к концу рабочего дня). Пик активности пользователя ```Darlana``` приходится на ночное время примерно до 4 часов утра.