---
title: "hw_4_3"
author: "Бикмаев Руслан"
date: "07 11 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ДЗ 4.3

 Для упражнения используются материалы и код предыдущего занятия.
1.Дополните данные, использованные в прошлом занятии столбцом с датами (без времени) и создайте анимированную визуализацию с проигрыванием движения по временному ряду как в примере на занятии  и с отображением уровня разговорчивости в каждый час (или 2-х, 3-х часовой отрезок) .
(помечен в комментариях, как  "# пример для ДЗ" в файле "code.R" с материалами урока ) 
Способ визуализации уровня уровня болтливости и привязки ко времени суток выбирите самостоятельно. 
Можно выбрать ограниченную выборку по времени, на которой наглядно видно изменчивость данного параметра.
2.К  заданию приложите датасет с преобразованными данными.csv, содержащими колонки:
"user", "date", "H", "count_W" 

Желательно сдать домашнее задание до 23:59 10.11.2019 г.

**Задание считается выполненным, когда:**
 * Домашняя работа сдана (1 балл)
 * Измерения проведены корректно, описание подробное (1 балл)
 * Код оформлен согласно рекомендациям tidyverse (1 балл)
 * Графики запускаются, отражают оговоренную в задаче взаимосвязь (2 балла)
 

**Минимальное количество баллов для зачета - 5**

### 1. Подготовка данных

```{r message=FALSE, results='hide'}
if(!require('pacman')) install.packages('pacman')
pacman::p_load(data.table, lubridate, ggplot2, stringr, colorspace)
```

```{r message=FALSE}
if (!exists('so')) {
  so <- fread('so.csv', encoding = 'UTF-8')
  so_ind <- copy(so) 
}

setnames(
  so,
  c('user', 'usid', 'postid', 'date', 'quoter', 'text', 'url', 'id', 'smth')
)

so[, c('smth') := NULL]
str(so)

so[, created := as.POSIXct(
    date,
    tz = 'UTC',
    format = ' %a %b %d, %Y %I:%M %p '
  )
]

so <- so[!is.na(created)]
so_cl <- copy(so)

# Ограничение периода
so <- so[year(created) > 2013]

so[, hour := {
  # Округлим даты при помощи lubridate
  h = floor_date(created, unit = '2 hours')
  # Другой вариант: as.numeric(format(created, '%H'))
  h = hour(h)
  }
]

so[, period := {
  # Округлим даты при помощи lubridate
  p = floor_date(created, unit = '3 months')
  # Другой вариант: as.numeric(format(created, '%H'))
  p = format(p, '%B %Y')
  }
]

setkey(so, user)
so <- so[user %chin% so[, .N, by = user][order(-N)][1:5, user]]

so[, nwords := stringr::str_count(text, "\\w+")]

so_sum <- so[,
  .(n_words  = sum(nwords)),
  keyby = .(user, hour)
]

so_total <- so_sum[,
  .(total_words = sum(n_words)),
  by = user
]

so_sum <- so_total[so_sum]
rm(so_total)
so_sum[, p_words := n_words / total_words]
```

### 2. Изображение

```{r}
p <- ggplot(
  so_sum,
  aes(
    x = hour,
    y = p_words,
    colour = factor(user),
    frame = period
  )) +
  geom_line(lwd = 2, show.legend = FALSE) +
  scale_x_continuous(
    'Время суток',
    breaks = seq(0, 22, 2),
    minor_breaks = NULL,
    limits = c(0, 22),
    expand = c(.01, .01),
    labels = function(x) sprintf('%d–%d', x, x + 2)
  ) +
  scale_y_continuous(
    '% от всех слов',
    labels = function(x) scales::percent(x, accuracy = 1)
  ) +
  scale_colour_discrete_qualitative(
    name = 'Пользователь',
    palette = 'Dynamic'
  ) +
  facet_wrap(~ user, ncol = 1) +
  theme_light() +
  ggtitle('ТОП-5 пользователей: активность по времени суток')

ggplotly(p)
```